{"version":3,"file":"actions.min.js","sources":["../src/actions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Common javascript for handling actions on the admin page and the user's view of the question bank.\n *\n * @module     qbank_columnsortorder/actions\n * @copyright  2023 onwards Catalyst IT Europe Ltd\n * @author     Mark Johnson <mark.johnson@catalyst-eu.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport SortableList from 'core/sortable_list';\nimport $ from 'jquery';\nimport * as repository from 'qbank_columnsortorder/repository';\nimport Notification from \"core/notification\";\nimport RefreshUi from 'core_question/refresh_ui';\n\nexport const SELECTORS = {\n    columnList: '.qbank-column-list',\n    sortableColumn: '.qbank-sortable-column',\n    removeLink: '[data-action=remove]',\n    moveHandler: '[data-drag-type=move]',\n    addColumn: '.addcolumn',\n    addLink: '[data-action=add]',\n    actionLink: '.action-link',\n};\n\n/**\n * Sets up sortable list in the column sort order page.\n *\n * @param {Element} listRoot Element containing the sortable list.\n * @param {Boolean} vertical Is the list in vertical orientation, rather than horizonal?\n * @param {Boolean} global Should changes be saved to global config, rather than user preferences?\n * @return {jQuery} sortable column elements, for attaching additional event listeners.\n */\nexport const setupSortableLists = (listRoot, vertical = false, global = false) => {\n    const sortableList = new SortableList(listRoot, {\n        moveHandlerSelector: SELECTORS.moveHandler,\n        isHorizontal: !vertical,\n    });\n    sortableList.getElementName = element => Promise.resolve(element.data('name'));\n\n    const sortableColumns = $(SELECTORS.sortableColumn);\n\n    sortableColumns.on(SortableList.EVENTS.DROP, () => {\n        repository.setColumnbankOrder(getColumnOrder(listRoot), global).catch(Notification.exception);\n        listRoot.querySelectorAll(SELECTORS.sortableColumn).forEach(item => item.classList.remove('active'));\n    });\n\n    sortableColumns.on(SortableList.EVENTS.DRAGSTART, (event) => {\n        event.currentTarget.classList.add('active');\n    });\n\n    return sortableColumns;\n};\n\n/**\n * Set up event handlers for action buttons.\n *\n * For each action, call the web service to update the appropriate setting or user preference, then call the fragment to\n * refresh the view.\n *\n * @param {Element} uiRoot The root of the question bank UI.\n * @param {Boolean} global Should changes be saved to global config, rather than user preferences?\n */\nexport const setupActionButtons = (uiRoot, global = false) => {\n    uiRoot.addEventListener('click', async(e) => {\n        const actionLink = e.target.closest(SELECTORS.actionLink);\n        if (!actionLink) {\n            return;\n        }\n        try {\n            e.preventDefault();\n            const action = actionLink.dataset.action;\n            if (action === 'add' || action === 'remove') {\n                const hiddenColumns = [];\n                const addColumnList = document.querySelector(SELECTORS.addColumn);\n                if (addColumnList) {\n                    addColumnList.querySelectorAll(SELECTORS.addLink).forEach(item => {\n                        if (action === 'add' && item === actionLink) {\n                            return;\n                        }\n                        hiddenColumns.push(item.dataset.column);\n                    });\n                }\n                if (action === 'remove') {\n                    hiddenColumns.push(actionLink.dataset.column);\n                }\n                await repository.setHiddenColumns(hiddenColumns, global);\n            } else if (action === 'reset') {\n                await repository.resetColumns(global);\n            }\n            const actionUrl = new URL(actionLink.href);\n            const returnUrl = new URL(actionUrl.searchParams.get('returnurl').replaceAll('&amp;', '&'));\n            await RefreshUi.refresh(uiRoot, returnUrl);\n        } catch (ex) {\n            await Notification.exception(ex);\n        }\n    });\n};\n\n/**\n * Gets the newly reordered columns to display in the question bank view.\n * @param {Element} listRoot\n * @returns {Array}\n */\nexport const getColumnOrder = listRoot => {\n    const columns = Array.from(listRoot.querySelectorAll('[data-columnid]'))\n        .map(column => column.dataset.columnid);\n\n    return columns.filter((value, index) => columns.indexOf(value) === index);\n};\n"],"names":["_getRequireWildcardCache","e","WeakMap","r","t","_interopRequireDefault","obj","__esModule","default","_sortable_list","_jquery","repository","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","_interopRequireWildcard","_notification","_refresh_ui","SELECTORS","_exports","columnList","sortableColumn","removeLink","moveHandler","addColumn","addLink","actionLink","setupSortableLists","listRoot","vertical","arguments","length","undefined","global","SortableList","moveHandlerSelector","isHorizontal","getElementName","element","Promise","resolve","data","sortableColumns","$","on","EVENTS","DROP","setColumnbankOrder","getColumnOrder","catch","Notification","exception","querySelectorAll","forEach","item","classList","remove","DRAGSTART","event","currentTarget","add","setupActionButtons","uiRoot","addEventListener","async","target","closest","preventDefault","action","dataset","hiddenColumns","addColumnList","document","querySelector","push","column","setHiddenColumns","resetColumns","actionUrl","URL","href","returnUrl","searchParams","replaceAll","RefreshUi","refresh","ex","columns","Array","from","map","columnid","filter","value","index","indexOf"],"mappings":"mPA4BiD,SAAAA,yBAAAC,GAAA,GAAA,mBAAAC,QAAA,OAAA,KAAA,IAAAC,EAAAD,IAAAA,QAAAE,EAAAF,IAAAA,eAAAF,yBAAA,SAAAC,GAAAA,OAAAA,EAAAG,EAAAD,IAAAF,EAAA,CAAA,SAAAI,uBAAAC,KAAAA,OAAAA,KAAAA,IAAAC,WAAAD,IAAAE,CAAAA,QAAAF,IAAA;;;;;;;;uKAJjDG,eAAAJ,uBAAAI,gBACAC,QAAAL,uBAAAK,SACAC,WAEiD,SAAAV,EAAAE,GAAAA,IAAAA,GAAAF,GAAAA,EAAAM,kBAAAN,EAAA,GAAA,OAAAA,GAAA,iBAAAA,GAAA,mBAAAA,EAAA,MAAA,CAAAO,QAAAP,GAAA,IAAAG,EAAAJ,yBAAAG,GAAAC,GAAAA,GAAAA,EAAAQ,IAAAX,GAAAG,OAAAA,EAAAS,IAAAZ,GAAAa,IAAAA,GAAAC,UAAA,MAAAC,EAAAC,OAAAC,gBAAAD,OAAAE,yBAAA,IAAA,IAAAC,KAAAnB,EAAA,GAAA,YAAAmB,GAAAH,OAAAI,UAAAC,eAAAC,KAAAtB,EAAAmB,GAAAI,CAAAA,IAAAA,EAAAR,EAAAC,OAAAE,yBAAAlB,EAAAmB,GAAA,KAAAI,IAAAA,EAAAX,KAAAW,EAAAC,KAAAR,OAAAC,eAAAJ,EAAAM,EAAAI,GAAAV,EAAAM,GAAAnB,EAAAmB,EAAA,CAAA,OAAAN,EAAAN,QAAAP,EAAAG,GAAAA,EAAAqB,IAAAxB,EAAAa,GAAAA,CAAA,CAFjDY,CAAAf,YACAgB,cAAAtB,uBAAAsB,eACAC,YAAAvB,uBAAAuB,aAEO,MAAMC,UAASC,SAAAD,UAAG,CACrBE,WAAY,qBACZC,eAAgB,yBAChBC,WAAY,uBACZC,YAAa,wBACbC,UAAW,aACXC,QAAS,oBACTC,WAAY,gBA8BdP,SAAAQ,mBAnBgC,SAACC,UAA+C,IAArCC,SAAQC,UAAAC,OAAA,QAAAC,IAAAF,UAAA,IAAAA,UAAA,GAAUG,OAAMH,UAAAC,OAAA,QAAAC,IAAAF,UAAA,IAAAA,UAAA,GAC5C,IAAII,eAAYrC,QAAC+B,SAAU,CAC5CO,oBAAqBjB,UAAUK,YAC/Ba,cAAeP,WAENQ,eAAiBC,SAAWC,QAAQC,QAAQF,QAAQG,KAAK,SAEtE,MAAMC,iBAAkB,EAAAC,QAAAA,SAAEzB,UAAUG,gBAWpC,OATAqB,gBAAgBE,GAAGV,eAAAA,QAAaW,OAAOC,MAAM,KACzC9C,WAAW+C,mBAAmBC,eAAepB,UAAWK,QAAQgB,MAAMC,cAAYrD,QAACsD,WACnFvB,SAASwB,iBAAiBlC,UAAUG,gBAAgBgC,SAAQC,MAAQA,KAAKC,UAAUC,OAAO,WAAU,IAGxGd,gBAAgBE,GAAGV,eAAYrC,QAACgD,OAAOY,WAAYC,QAC/CA,MAAMC,cAAcJ,UAAUK,IAAI,SAAS,IAGxClB,iBA8CTvB,SAAA0C,mBAlCgC,SAACC,QAA2B,IAAnB7B,OAAMH,UAAAC,OAAA,QAAAC,IAAAF,UAAA,IAAAA,UAAA,GAC7CgC,OAAOC,iBAAiB,SAASC,UAC7B,MAAMtC,WAAapC,EAAE2E,OAAOC,QAAQhD,UAAUQ,YAC9C,GAAKA,WAGL,IACIpC,EAAE6E,iBACF,MAAMC,OAAS1C,WAAW2C,QAAQD,OAClC,GAAe,QAAXA,QAA+B,WAAXA,OAAqB,CACzC,MAAME,cAAgB,GAChBC,cAAgBC,SAASC,cAAcvD,UAAUM,WACnD+C,eACAA,cAAcnB,iBAAiBlC,UAAUO,SAAS4B,SAAQC,OACvC,QAAXc,QAAoBd,OAAS5B,YAGjC4C,cAAcI,KAAKpB,KAAKe,QAAQM,OAAO,IAGhC,WAAXP,QACAE,cAAcI,KAAKhD,WAAW2C,QAAQM,cAEpC3E,WAAW4E,iBAAiBN,cAAerC,OACrD,KAAsB,UAAXmC,cACDpE,WAAW6E,aAAa5C,QAElC,MAAM6C,UAAY,IAAIC,IAAIrD,WAAWsD,MAC/BC,UAAY,IAAIF,IAAID,UAAUI,aAAahF,IAAI,aAAaiF,WAAW,QAAS,YAChFC,oBAAUC,QAAQvB,OAAQmB,UACnC,CAAC,MAAOK,UACCpC,cAAYrD,QAACsD,UAAUmC,GACjC,MASD,MAAMtC,eAAiBpB,WAC1B,MAAM2D,QAAUC,MAAMC,KAAK7D,SAASwB,iBAAiB,oBAChDsC,KAAIf,QAAUA,OAAON,QAAQsB,WAElC,OAAOJ,QAAQK,QAAO,CAACC,MAAOC,QAAUP,QAAQQ,QAAQF,SAAWC,OAAM,EAC3E3E,SAAA6B,eAAAA,cAAA"}