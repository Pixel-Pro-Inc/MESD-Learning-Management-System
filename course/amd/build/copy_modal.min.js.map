{"version":3,"file":"copy_modal.min.js","sources":["../src/copy_modal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module provides the course copy modal from the course and\n * category management screen.\n *\n * @module     core_course/copy_modal\n * @copyright  2020 onward The Moodle Users Association <https://moodleassociation.org/>\n * @author     Matt Porritt <mattp@catalyst-au.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.9\n */\n\nimport {get_string as getString} from 'core/str';\nimport Modal from 'core/modal';\nimport * as ajax from 'core/ajax';\nimport * as Fragment from 'core/fragment';\nimport Notification from 'core/notification';\nimport * as Config from 'core/config';\n\nexport default class CopyModal {\n    static init(context) {\n        return new CopyModal(context);\n    }\n\n    constructor(context) {\n        this.contextid = context;\n\n        this.registerEventListeners();\n    }\n\n    registerEventListeners() {\n        document.addEventListener('click', (e) => {\n            const copyAction = e.target.closest('.action-copy');\n            if (!copyAction) {\n                return;\n            }\n            e.preventDefault(); // Stop. Hammer time.\n\n            const url = new URL(copyAction.href);\n            const params = new URLSearchParams(url.search);\n\n            this.fetchCourseData(params.get('id'))\n            .then(([course]) => this.createModal(course))\n            .catch((error) => Notification.exception(error));\n        });\n    }\n\n    fetchCourseData(courseid) {\n        return ajax.call([{\n            methodname: 'core_course_get_courses',\n            args: {\n                options: {\n                    ids: [courseid],\n                },\n            },\n        }])[0];\n    }\n\n    submitBackupRequest(jsonformdata) {\n        return ajax.call([{\n            methodname: 'core_backup_submit_copy_form',\n            args: {\n                jsonformdata,\n            },\n        }])[0];\n    }\n\n    createModal(\n        course,\n        formdata = {},\n    ) {\n        const params = {\n            jsonformdata: JSON.stringify(formdata),\n            courseid: course.id,\n        };\n\n        // Create the Modal.\n        return Modal.create({\n            title: getString('copycoursetitle', 'backup', course.shortname),\n            body: Fragment.loadFragment('course', 'new_base_form', this.contextid, params),\n            large: true,\n            show: true,\n            removeOnClose: true,\n        })\n        .then((modal) => {\n            // Explicitly handle form click events.\n            modal.getRoot().on('click', '#id_submitreturn', (e) => {\n                this.processModalForm(course, modal, e);\n            });\n            modal.getRoot().on('click', '#id_cancel', (e) => {\n                e.preventDefault();\n                modal.hide();\n            });\n            modal.getRoot().on('click', '#id_submitdisplay', (e) => {\n                e.formredirect = true;\n                this.processModalForm(course, modal, e);\n\n            });\n\n            return modal;\n        });\n    }\n\n    processModalForm(course, modal, e) {\n        e.preventDefault(); // Stop modal from closing.\n\n        // Form data.\n        const copyform = modal.getRoot().find('form').serialize();\n        const formjson = JSON.stringify(copyform);\n\n        // Handle invalid form fields for better UX.\n        const invalid = modal.getRoot()[0].querySelectorAll('[aria-invalid=\"true\"], .error');\n        if (invalid.length) {\n            invalid[0].focus();\n            return;\n        }\n\n        modal.hide();\n\n        // Submit form via ajax.\n        this.submitBackupRequest(formjson)\n        .then(() => {\n            if (e.formredirect == true) {\n                // We are redirecting to copy progress display.\n                const redirect = `${Config.wwwroot}/backup/copyprogress.php?id=${course.id}`;\n                window.location.assign(redirect);\n            }\n\n            return;\n        })\n        .catch(() => {\n            // Form submission failed server side, redisplay with errors.\n            this.createModal(course, copyform);\n        });\n    }\n}\n"],"names":["_getRequireWildcardCache","e","WeakMap","r","t","_interopRequireWildcard","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","_interopRequireDefault","obj","_modal","ajax","Fragment","_notification","Config","CopyModal","init","context","constructor","this","contextid","registerEventListeners","document","addEventListener","copyAction","target","closest","preventDefault","url","URL","href","params","URLSearchParams","search","fetchCourseData","then","_ref","course","createModal","catch","error","Notification","exception","courseid","methodname","args","options","ids","submitBackupRequest","jsonformdata","formdata","arguments","length","undefined","JSON","stringify","id","Modal","create","title","getString","shortname","body","loadFragment","large","show","removeOnClose","modal","getRoot","on","processModalForm","hide","formredirect","copyform","find","serialize","formjson","invalid","querySelectorAll","focus","redirect","wwwroot","window","location","assign","_exports"],"mappings":"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"}